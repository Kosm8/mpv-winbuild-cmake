#!/bin/bash
PROG=@CMAKE_INSTALL_PREFIX@/bin/ld.lld
TARGET=@TARGET_ARCH@
POLICY="cache_size_bytes=4g:prune_interval=1m"
FLAGS="-m @ld_m_flag@"
FLAGS="$FLAGS --pdb= --thinlto-cache-dir=@MINGW_INSTALL_PREFIX@/thinlto --thinlto-cache-policy=$POLICY"
FLAGS="$FLAGS -O3 --lto-O3 --lto-CGO3 -mllvm=-disable-auto-upgrade-debug-info"
FLAGS="$FLAGS --no-insert-timestamp --major-os-version=10 --major-subsystem-version=6 --minor-subsystem-version=2 --file-alignment=4096 --build-id=none"

if [ "$CONF" == "1" ]; then
    SKIP_OPT="-O0 --lto-O0 --lto-CGO0 --no-gc-sections --no-guard-cf"
fi

if [ "$GC" != "0" ]; then
    LLD_GC="--gc-sections --icf=all"
fi

if [ "$CFI" != "0" ];then
    FLAGS="$FLAGS @lld_cfi@"
fi

"$PROG" "$@" $FLAGS $LLD_GC @LLD_FLAGS@ $SKIP_OPT
